<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Manager — Sales</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding:18px; background:#f8f9fa }
  </style>
</head>
<body>
<div class="container">
  <div class="d-flex justify-content-between align-items-center">
    <h1>Manager Dashboard</h1>
    <button id="logoutBtn" class="btn btn-sm btn-outline-secondary">Logout</button>
  </div>

  <hr />

  <div class="row">
    <div class="col-md-6">
      <h5>Add / Edit Product</h5>
      <form id="productForm">
        <div class="mb-2"><input id="code" class="form-control" placeholder="Product Code (unique)" required></div>
        <div class="mb-2"><input id="name" class="form-control" placeholder="Name" required></div>
        <div class="mb-2"><input id="price" type="number" step="0.01" class="form-control" placeholder="Price" required></div>
        <div class="mb-2"><input id="stock" type="number" class="form-control" placeholder="Stock" required></div>
        <input type="hidden" id="editingId" />
        <div><button class="btn btn-primary">Save Product</button></div>
      </form>
    </div>

    <div class="col-md-6">
      <h5>Products</h5>
      <!-- 🔹 Search Bar -->
      <div class="mb-2">
        <input id="productSearch" class="form-control" placeholder="Search products by name or code">
      </div>
      <ul id="productList" class="list-group"></ul>
    </div>
  </div>

  <hr />
  <h5>User Management</h5>
  <form id="userCreateForm" class="row g-2" style="max-width:420px">
    <div class="col-12"><input id="newEmail" type="email" class="form-control" placeholder="New user email" required></div>
    <div class="col-12"><input id="newPassword" type="password" class="form-control" placeholder="Password" required></div>
    <div class="col-12">
      <select id="newRole" class="form-select">
        <option value="receptionist">Receptionist</option>
        <option value="manager">Manager</option>
      </select>
    </div>
    <div class="col-12"><button class="btn btn-success">Create User</button></div>
  </form>

  <hr />
  <h5>Sales History</h5>

  <div class="row g-2 mb-3">
    <div class="col-md-3">
      <input type="date" id="startDate" class="form-control">
    </div>
    <div class="col-md-3">
      <input type="date" id="endDate" class="form-control">
    </div>
    <div class="col-md-3">
      <button id="filterBtn" class="btn btn-primary w-100">Filter</button>
    </div>
    <div class="col-md-3">
      <button id="resetBtn" class="btn btn-secondary w-100">Reset</button>
    </div>
  </div>

  <div class="mb-3">
    <button id="clearSalesBtn" class="btn btn-danger w-100">Clear Sales History</button>
  </div>

  <div id="salesHistory"></div>
</div>

<script type="module">
import { auth, db } from './firebase-config.js';
import {
  onAuthStateChanged, signOut
} from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
import {
  doc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc,
  query, where, getDoc, orderBy, onSnapshot
} from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

// --- Secondary Firebase App for creating users (prevents logout) ---
import { initializeApp as initApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
import { getAuth as getSecondaryAuth, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

const secondaryApp = initApp({
  apiKey: "AIzaSyAGrBbHkK_xQvcWTr6wk2NDqwXhSI-AYys",
  authDomain: "abimbest-sales-management.firebaseapp.com",
  projectId: "abimbest-sales-management",
  storageBucket: "abimbest-sales-management.firebasestorage.app",
  messagingSenderId: "400811478351",
  appId: "1:400811478351:web:4ad21456c998776f0e893a"
}, "SecondaryApp");

const secondaryAuth = getSecondaryAuth(secondaryApp);

let allProducts = []; // 🔹 store all products globally

// 🔹 Access check
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = 'index.html';
    return;
  }
  listenProducts(); // real-time products
  listenSales();   // default sales load
});

// 🔹 Logout
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = 'index.html';
});

// 🔹 Create User
document.getElementById('userCreateForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('newEmail').value.trim();
  const password = document.getElementById('newPassword').value.trim();
  const role = document.getElementById('newRole').value;
  if(!email || !password) return alert('Email and password required');
  try {
    const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
    await setDoc(doc(db, 'users', cred.user.uid), { role });
    alert(`User ${email} created with role ${role}`);
  } catch(err) {
    alert('Failed to create user: ' + err.message);
  }
});

// 🔹 Product Form
document.getElementById('productForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const code = document.getElementById('code').value.trim();
  const name = document.getElementById('name').value.trim();
  const price = parseFloat(document.getElementById('price').value);
  const stock = parseInt(document.getElementById('stock').value,10);
  const editingId = document.getElementById('editingId').value;
  if(!code||!name||isNaN(price)||isNaN(stock)) return alert('Invalid product data');

  if(editingId){
    await updateDoc(doc(db, 'products', editingId), { code, name, price, stock });
  } else {
    const q = query(collection(db,'products'), where('code', '==', code));
    const snap = await getDocs(q);
    if(!snap.empty && !confirm('Product code exists. Create duplicate?')) return;
    await addDoc(collection(db, 'products'), { code, name, price, stock });
  }
  document.getElementById('productForm').reset();
});

// 🔹 Real-time Products
function listenProducts(){
  const productsRef = collection(db,'products');
  onSnapshot(productsRef, (snap)=>{
    allProducts = [];
    snap.forEach(s=>{
      allProducts.push({ id: s.id, ...s.data() });
    });
    renderProducts(allProducts);
  });
}

// 🔹 Render Products
function renderProducts(products){
  const list = document.getElementById('productList');
  list.innerHTML = '';
  if (products.length === 0) {
    list.innerHTML = "<li class='list-group-item text-muted'>No products found.</li>";
    return;
  }
  products.forEach(p=>{
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `
      <div>
        <strong>${escapeHtml(p.name)}</strong> <br>
        Code: ${escapeHtml(p.code)} • ₦${Number(p.price).toFixed(2)} • Stock: ${p.stock}
      </div>
      <div>
        <button class="btn btn-sm btn-secondary me-1" onclick='editProduct("${p.id}")'>Edit</button>
        <button class="btn btn-sm btn-danger" onclick='deleteProduct("${p.id}")'>Delete</button>
      </div>
    `;
    list.appendChild(li);
  });
}

// 🔹 Product Search
document.getElementById('productSearch').addEventListener('input', (e)=>{
  const term = e.target.value.toLowerCase();
  const filtered = allProducts.filter(p=>
    p.name.toLowerCase().includes(term) ||
    p.code.toLowerCase().includes(term)
  );
  renderProducts(filtered);
});

window.editProduct = async function(id){
  const d = await getDoc(doc(db,'products',id));
  if(!d.exists()) return alert('Missing product');
  const data = d.data();
  document.getElementById('editingId').value = id;
  document.getElementById('code').value = data.code || '';
  document.getElementById('name').value = data.name || '';
  document.getElementById('price').value = data.price || '';
  document.getElementById('stock').value = data.stock || '';
}

window.deleteProduct = async function(id){
  if(!confirm('Delete product?')) return;
  await deleteDoc(doc(db,'products',id));
}

// 🔹 Listen to Sales (default load)
function listenSales(){
  loadSales();
}

// 🔹 Load Sales (with optional filter)
async function loadSales(startDate = null, endDate = null) {
  const salesDiv = document.getElementById('salesHistory');
  salesDiv.innerHTML = '';
  
  let qRef = collection(db,'sales');
  if (startDate && endDate) {
    qRef = query(qRef,
      where("date", ">=", startDate),
      where("date", "<=", endDate),
      orderBy("date", "desc")
    );
  } else {
    qRef = query(qRef, orderBy("date", "desc"));
  }

  const snap = await getDocs(qRef);
  if (snap.empty) {
    salesDiv.innerHTML = "<div class='alert alert-info'>No sales found for the selected range.</div>";
    return;
  }

  snap.forEach(s=>{
    const data = s.data();
    const card = document.createElement('div');
    card.className = 'p-3 mb-2 bg-white border';
    
    const timestamp = data.date?.toDate ? data.date.toDate() : null;
    let dateStr = '';
    if (timestamp) {
        const day = String(timestamp.getDate()).padStart(2, '0');
        const month = String(timestamp.getMonth() + 1).padStart(2, '0');
        const year = timestamp.getFullYear();
        const hours = String(timestamp.getHours()).padStart(2, '0');
        const minutes = String(timestamp.getMinutes()).padStart(2, '0');
        const seconds = String(timestamp.getSeconds()).padStart(2, '0');
        dateStr = `${day}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
    }

    card.innerHTML = `
      <div><strong>Date:</strong> ${escapeHtml(dateStr)}</div>
      <div><strong>Total:</strong> ₦${Number(data.total).toFixed(2)}</div>
      <ul>${(data.items||[]).map(it=>`<li>${escapeHtml(it.name)} x ${it.qty} — ₦${(it.price*it.qty).toFixed(2)}</li>`).join('')}</ul>
    `;
    salesDiv.appendChild(card);
  });
}

// 🔹 Filter Button
document.getElementById('filterBtn').addEventListener('click', () => {
  const startVal = document.getElementById('startDate').value;
  const endVal = document.getElementById('endDate').value;
  if (!startVal || !endVal) {
    alert("Please select both start and end dates.");
    return;
  }
  const start = new Date(startVal);
  const end = new Date(endVal);
  end.setHours(23, 59, 59, 999);
  loadSales(start, end);
});

// 🔹 Reset Button
document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  loadSales();
});

// 🔹 Clear All Sales
document.getElementById('clearSalesBtn').addEventListener('click', async ()=>{
  if(!confirm('⚠️ This will permanently delete ALL sales records. Continue?')) return;

  const snap = await getDocs(collection(db,'sales'));
  if(snap.empty){
    alert('No sales records to delete.');
    return;
  }

  const batchDeletes = [];
  snap.forEach(docSnap=>{
    batchDeletes.push(deleteDoc(doc(db,'sales', docSnap.id)));
  });

  await Promise.all(batchDeletes);
  alert('All sales records cleared!');
  loadSales();
});

function escapeHtml(t){ return String(t).replace(/[&<>\"]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
</script>
</body>
</html>
