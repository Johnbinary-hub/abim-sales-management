<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receipt</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div id="receipt" class="border p-3">
    <h2 class="text-center">Abimbest Phones & Accessories</h2>
    <p class="text-center">Thanks for your patronage</p>
    <p id="date"></p>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="items"></tbody>
    </table>
    <h4 class="text-end" id="total"></h4>
  </div>

  <script type="module">
    import { db } from './firebase-config.js';
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const saleId = params.get('saleId');
    if (!saleId) {
      document.body.innerHTML = '<p class="text-danger">No sale ID provided.</p>';
      throw new Error("No sale ID");
    }

    const saleRef = doc(db, 'sales', saleId);
    const snap = await getDoc(saleRef);

    if (!snap.exists()) {
      document.body.innerHTML = '<p class="text-danger">Sale not found.</p>';
      throw new Error("Sale not found");
    }

    const sale = snap.data();
    document.getElementById('date').textContent = `Date: ${sale.date.toDate().toLocaleString()}`;

    const tbody = document.getElementById('items');
    sale.items.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.name}</td>
        <td>${item.qty}</td>
        <td>₦${item.price}</td>
        <td>₦${(item.qty * item.price).toFixed(2)}</td>
      `;
      tbody.appendChild(row);
    });

    document.getElementById('total').textContent = `Total: ₦${sale.total.toFixed(2)}`;

    // Auto print after loading, then notify opener and close
    window.print();
    window.onafterprint = () => {
      if (window.opener) {
        window.opener.postMessage('refreshDashboard', '*');
      }
      window.close();
    };
  </script>
</body>
</html>
