<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receptionist Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #suggestions {
      position: absolute;
      z-index: 1000;
      width: 100%;
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
    }
    #suggestions div {
      padding: 5px 10px;
      cursor: pointer;
    }
    #suggestions div:hover {
      background: #f1f1f1;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Receptionist Dashboard</h1>
      <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
    </div>

    <div class="card p-3 mb-4 position-relative">
      <input type="text" id="searchCode" class="form-control" placeholder="Enter product name">
      <div id="suggestions" class="d-none"></div>
    </div>

    <div class="card p-3 mb-4">
      <h5>Available Products</h5>
      <ul id="productList" class="list-group mb-3"></ul>
    </div>

    <div class="card p-3 mb-4">
      <h5>Cart</h5>
      <ul id="cart" class="list-group mb-3"></ul>
      <h6 id="cartTotal" class="text-end fw-bold">Total: ₦0</h6>
      <button id="finalizeBtn" class="btn btn-success">Finalize Sale & Print Receipt</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      collection,
      query,
      orderBy,
      startAt,
      endAt,
      getDocs,
      doc,
      runTransaction,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    let cart = [];
    const searchInput = document.getElementById('searchCode');
    const suggestionsBox = document.getElementById('suggestions');
    const productList = document.getElementById('productList');

    // Auth check
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'index.html';
    });

    // Listen for refresh signal from receipt
    window.addEventListener('message', (event) => {
      if (event.data === 'refreshDashboard') {
        location.reload();
      }
    });

    // Fetch all products on page load
    async function loadAllProducts() {
      const colRef = collection(db, 'products');
      const nameQ = query(colRef, orderBy('name'));
      const nameSnap = await getDocs(nameQ);

      productList.innerHTML = '';
      nameSnap.forEach(docSnap => {
        const prod = { id: docSnap.id, ...docSnap.data() };
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `${prod.name} (Code: ${prod.code}) - ₦${prod.price}`;
        li.addEventListener('click', () => selectProduct(prod));
        productList.appendChild(li);
      });
    }
    loadAllProducts();

    // Live suggestions (search only by name but display code too)
    searchInput.addEventListener('input', async () => {
      const term = searchInput.value.trim().toLowerCase();
      if (!term) {
        suggestionsBox.classList.add('d-none');
        return;
      }

      const colRef = collection(db, 'products');
      const nameQ = query(colRef, orderBy('name'), startAt(term), endAt(term + '\uf8ff'));

      const nameSnap = await getDocs(nameQ);

      let results = [];
      nameSnap.forEach(docSnap => results.push({ id: docSnap.id, ...docSnap.data() }));

      if (results.length === 0) {
        suggestionsBox.classList.add('d-none');
        return;
      }

      suggestionsBox.innerHTML = '';
      results.forEach(prod => {
        const div = document.createElement('div');
        div.textContent = `${prod.name} (Code: ${prod.code}) - ₦${prod.price}`;
        div.addEventListener('click', () => selectProduct(prod));
        suggestionsBox.appendChild(div);
      });
      suggestionsBox.classList.remove('d-none');
    });

    // Select product from list or suggestion
    function selectProduct(product) {
      suggestionsBox.classList.add('d-none');
      searchInput.value = '';
      const qty = parseInt(prompt(`Enter quantity for ${product.name}`), 10);
      if (!qty || qty < 1) return;
      cart.push({ id: product.id, name: product.name, price: product.price, qty });
      renderCart();
    }

    // Render cart
    function renderCart() {
      const cartList = document.getElementById('cart');
      const cartTotalElem = document.getElementById('cartTotal');

      cartList.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          ${item.name} - ${item.qty} x ₦${item.price}
          <button class="btn btn-sm btn-danger">Remove</button>
        `;
        li.querySelector('button').addEventListener('click', () => {
          cart.splice(index, 1);
          renderCart();
        });
        cartList.appendChild(li);

        total += item.qty * item.price;
      });

      cartTotalElem.textContent = `Total: ₦${total.toLocaleString()}`;
    }

    // Finalize sale
    document.getElementById('finalizeBtn').addEventListener('click', async () => {
      if (cart.length === 0) {
        alert('Cart is empty');
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          const productDocs = [];
          for (let item of cart) {
            const ref = doc(db, "products", item.id);
            const snap = await transaction.get(ref);
            if (!snap.exists()) throw `Product ${item.name} does not exist`;
            productDocs.push({ ref, data: snap.data(), qty: item.qty, name: item.name });
          }
          for (let p of productDocs) {
            const newStock = p.data.stock - p.qty;
            if (newStock < 0) throw `Not enough stock for ${p.name}`;
            transaction.update(p.ref, { stock: newStock });
          }
        });

        const saleRef = await addDoc(collection(db, 'sales'), {
          items: cart,
          date: new Date(),
          total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0)
        });

        window.open(`reciept.html?saleId=${saleRef.id}`, '_blank');

        cart = [];
        renderCart();
        loadAllProducts(); // refresh product list after sale

      } catch (e) {
        alert("Sale failed: " + e);
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
  </script>
</body>
</html>
