<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receptionist Dashboard</title>
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      collection,
      query,
      where,
      getDocs,
      doc,
      runTransaction,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    let cart = [];

    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = 'index.html';
      }
    });

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const searchCode = document.getElementById('searchCode').value.trim();
      if (!searchCode) return alert('Enter a product code');

      const q = query(collection(db, 'products'), where('code', '==', searchCode));
      const snap = await getDocs(q);

      if (snap.empty) {
        alert('Product not found');
        return;
      }

      snap.forEach(docSnap => {
        const product = docSnap.data();
        const qty = parseInt(prompt(`Enter quantity for ${product.name}`), 10);
        if (!qty || qty < 1) return;
        cart.push({ id: docSnap.id, name: product.name, price: product.price, qty });
      });

      renderCart();
    });

    function renderCart() {
      const cartList = document.getElementById('cart');
      cartList.innerHTML = '';
      cart.forEach(item => {
        const li = document.createElement('li');
        li.textContent = `${item.name} - ${item.qty} x ${item.price}`;
        cartList.appendChild(li);
      });
    }

    document.getElementById('finalizeBtn').addEventListener('click', async () => {
      if (cart.length === 0) {
        alert('Cart is empty');
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          const productDocs = [];

          // Step 1: Read all products first
          for (let item of cart) {
            const ref = doc(db, "products", item.id);
            const snap = await transaction.get(ref);
            if (!snap.exists()) {
              throw `Product ${item.name} does not exist`;
            }
            productDocs.push({ ref, data: snap.data(), qty: item.qty, name: item.name });
          }

          // Step 2: Update stock for all products
          for (let p of productDocs) {
            const newStock = p.data.stock - p.qty;
            if (newStock < 0) throw `Not enough stock for ${p.name}`;
            transaction.update(p.ref, { stock: newStock });
          }
        });

        // Step 3: Save sale record
        await addDoc(collection(db, 'sales'), {
          items: cart,
          date: new Date()
        });

        alert('Sale finalized successfully');
        cart = [];
        renderCart();

      } catch (e) {
        console.error("Sale failed: ", e);
        alert("Sale failed: " + e);
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      signOut(auth);
    });
  </script>
</head>
<body>
  <h1>Receptionist Dashboard</h1>
  <input type="text" id="searchCode" placeholder="Enter product code">
  <button id="searchBtn">Search</button>
  <ul id="cart"></ul>
  <button id="finalizeBtn">Finalize Sale</button>
  <button id="logoutBtn">Logout</button>
</body>
</html>
