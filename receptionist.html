<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Receptionist Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .search-container {
      display: flex;
      gap: 8px;
      width: 100%;
    }
    #suggestions {
      background: white;
      border: 1px solid #ccc;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
    }
    #suggestions div {
      padding: 5px 10px;
      cursor: pointer;
    }
    #suggestions div:hover {
      background: #f1f1f1;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3">Receptionist Dashboard</h1>
      <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">Logout</button>
    </div>

    <!-- Search bar -->
    <div class="card p-3 mb-3">
      <div class="search-container">
        <input type="text" id="searchCode" class="form-control" placeholder="Enter product name or code">
        <button id="clearSearchBtn" class="btn btn-outline-secondary">Clear</button>
      </div>
    </div>

    <!-- Search results dropdown -->
    <div class="card p-3 mb-4 d-none" id="suggestions"></div>

    <div class="card p-3 mb-4">
      <h5>Available Products</h5>
      <ul id="productList" class="list-group mb-3"></ul>
    </div>

    <div class="card p-3 mb-4">
      <h5>Cart</h5>
      <ul id="cart" class="list-group mb-3"></ul>
      <h6 id="cartTotal" class="text-end fw-bold">Total: ₦0</h6>
      <button id="finalizeBtn" class="btn btn-success">Finalize Sale & Print Receipt</button>
    </div>
  </div>

  <script type="module">
    import { auth, db } from './firebase-config.js';
    import {
      collection,
      query,
      orderBy,
      startAt,
      endAt,
      getDocs,
      doc,
      runTransaction,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    let cart = [];
    const searchInput = document.getElementById('searchCode');
    const suggestionsBox = document.getElementById('suggestions');
    const productList = document.getElementById('productList');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    // Auth check
    onAuthStateChanged(auth, user => {
      if (!user) window.location.href = 'index.html';
    });

    // Listen for refresh signal from receipt
    window.addEventListener('message', (event) => {
      if (event.data === 'refreshDashboard') {
        location.reload();
      }
    });

    // Fetch all products on page load
    async function loadAllProducts() {
      const colRef = collection(db, 'products');
      const q = query(colRef, orderBy('name'));
      const snap = await getDocs(q);

      productList.innerHTML = '';
      snap.forEach(docSnap => {
        const prod = { id: docSnap.id, ...docSnap.data() };
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = `${prod.name} (Code: ${prod.code}) - ₦${prod.price}`;
        li.addEventListener('click', () => selectProduct(prod));
        productList.appendChild(li);
      });
    }
    loadAllProducts();

    // Clear search box & reload products
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      suggestionsBox.classList.add('d-none');
      loadAllProducts();
    });

    // Live suggestions (search by name OR code)
    searchInput.addEventListener('input', async () => {
      const term = searchInput.value.trim().toLowerCase();
      if (!term) {
        suggestionsBox.classList.add('d-none');
        return;
      }

      const colRef = collection(db, 'products');
      const nameSnap = await getDocs(query(colRef, orderBy('name')));
      const codeSnap = await getDocs(query(colRef, orderBy('code')));

      const results = [];
      nameSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name.toLowerCase().includes(term)) results.push({ id: docSnap.id, ...data });
      });
      codeSnap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.code.toLowerCase().includes(term) && !results.find(r => r.id === docSnap.id)) {
          results.push({ id: docSnap.id, ...data });
        }
      });

      if (results.length === 0) {
        suggestionsBox.classList.add('d-none');
        return;
      }

      suggestionsBox.innerHTML = '';
      results.forEach(prod => {
        const div = document.createElement('div');
        div.textContent = `${prod.name} (Code: ${prod.code}) - ₦${prod.price}`;
        div.addEventListener('click', () => selectProduct(prod));
        suggestionsBox.appendChild(div);
      });
      suggestionsBox.classList.remove('d-none');
    });

    // Select product
    function selectProduct(product) {
      suggestionsBox.classList.add('d-none');
      searchInput.value = '';
      const qty = parseInt(prompt(`Enter quantity for ${product.name}`), 10);
      if (!qty || qty < 1) return;

      cart.push({
        id: product.id,
        name: product.name,
        code: product.code,
        price: product.price,
        qty
      });

      renderCart();
    }

    // Render cart
    function renderCart() {
      const cartList = document.getElementById('cart');
      const cartTotalElem = document.getElementById('cartTotal');

      cartList.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          ${item.name} (${item.code}) - ${item.qty} x ₦${item.price}
          <button class="btn btn-sm btn-danger">Remove</button>
        `;
        li.querySelector('button').addEventListener('click', () => {
          cart.splice(index, 1);
          renderCart();
        });
        cartList.appendChild(li);

        total += item.qty * item.price;
      });

      cartTotalElem.textContent = `Total: ₦${total.toLocaleString()}`;
    }

    // Finalize sale
    document.getElementById('finalizeBtn').addEventListener('click', async () => {
      if (cart.length === 0) {
        alert('Cart is empty');
        return;
      }

      try {
        await runTransaction(db, async (transaction) => {
          const productDocs = [];
          for (let item of cart) {
            const ref = doc(db, "products", item.id);
            const snap = await transaction.get(ref);
            if (!snap.exists()) throw `Product ${item.name} does not exist`;
            productDocs.push({ ref, data: snap.data(), qty: item.qty, name: item.name });
          }
          for (let p of productDocs) {
            const newStock = p.data.stock - p.qty;
            if (newStock < 0) throw `Not enough stock for ${p.name}`;
            transaction.update(p.ref, { stock: newStock });
          }
        });

        const saleRef = await addDoc(collection(db, 'sales'), {
          items: cart,
          date: new Date(),
          total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0)
        });

        // Open receipt with correct sale ID
        window.open(`receipt.html?saleId=${saleRef.id}`, "_blank");

        cart = [];
        renderCart();
        loadAllProducts();

      } catch (e) {
        alert("Sale failed: " + e);
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

  </script>
</body>
</html>
