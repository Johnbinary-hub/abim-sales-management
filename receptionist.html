<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receptionist â€” Abimbest Phones & Accessories</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #f8f9fa; }
    .cart-table th, .cart-table td { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header with Logout -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Receptionist Dashboard</h2>
    <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
  </div>

  <!-- Search by product code -->
  <div class="input-group mb-3">
    <input type="text" id="searchCode" class="form-control" placeholder="Enter product code">
    <button class="btn btn-primary" id="searchBtn">Search Product</button>
  </div>

  <!-- Cart table -->
  <table class="table table-bordered cart-table">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price (â‚¦)</th>
        <th>Qty</th>
        <th>Total (â‚¦)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="cartBody"></tbody>
  </table>

  <div class="d-flex justify-content-between">
    <h5>Total: â‚¦<span id="cartTotal">0.00</span></h5>
    <button class="btn btn-success" id="finalizeBtn">Finalize Sale</button>
  </div>
</div>

<script type="module">
import { auth, db } from './firebase-config.js';
import { doc, getDoc, collection, query, where, getDocs, serverTimestamp, runTransaction } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
import { signOut } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';

// ðŸ”¹ Logout button functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
  try {
    await signOut(auth);
    window.location.href = 'index.html';
  } catch (err) {
    console.error(err);
    alert('Logout failed: ' + err.message);
  }
});

let cart = [];

function renderCart() {
  const body = document.getElementById('cartBody');
  body.innerHTML = '';
  let total = 0;
  cart.forEach((item, idx) => {
    const itemTotal = item.price * item.qty;
    total += itemTotal;
    body.innerHTML += `
      <tr>
        <td>${item.name}</td>
        <td>${item.price.toFixed(2)}</td>
        <td>${item.qty}</td>
        <td>${itemTotal.toFixed(2)}</td>
        <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${idx})">Remove</button></td>
      </tr>
    `;
  });
  document.getElementById('cartTotal').innerText = total.toFixed(2);
}

window.removeFromCart = function(index) {
  cart.splice(index, 1);
  renderCart();
};

// Search product by code
document.getElementById('searchBtn').addEventListener('click', async () => {
  const code = document.getElementById('searchCode').value.trim();
  if (!code) return alert('Enter a product code');
  const q = query(collection(db, 'products'), where('code', '==', code));
  const snap = await getDocs(q);
  if (snap.empty) {
    alert('Product not found');
    return;
  }
  snap.forEach(docSnap => {
    const product = docSnap.data();
    const qty = parseInt(prompt(`Enter quantity for ${product.name}`), 10);
    if (!qty || qty < 1) return;
    cart.push({ id: docSnap.id, name: product.name, price: product.price, qty });
  });
  renderCart();
});

// Finalize sale
document.getElementById('finalizeBtn').addEventListener('click', async () => {
  if (cart.length === 0) return alert('Cart is empty');
  try {
    await runTransaction(db, async (tx) => {
      const needed = {};
      cart.forEach(i => needed[i.id] = (needed[i.id] || 0) + i.qty);
      for (const productId of Object.keys(needed)) {
        const pRef = doc(db, 'products', productId);
        const pSnap = await tx.get(pRef);
        if (!pSnap.exists()) throw new Error('Product missing');
        const curStock = pSnap.data().stock || 0;
        if (curStock < needed[productId]) throw new Error(`Insufficient stock for ${pSnap.data().name}`);
        tx.update(pRef, { stock: curStock - needed[productId] });
      }
      const sale = {
        items: cart,
        total: cart.reduce((s,x) => s + x.price*x.qty, 0),
        cashier: auth.currentUser ? auth.currentUser.uid : null,
        date: serverTimestamp()
      };
      const salesCol = collection(db, 'sales');
      const newSaleRef = doc(salesCol);
      tx.set(newSaleRef, sale);
    });

    const receiptData = {
      items: cart,
      total: cart.reduce((s,x) => s + x.price*x.qty, 0),
      date: new Date().toLocaleString()
    };
    localStorage.setItem('receiptData', JSON.stringify(receiptData));

    fetch('http://localhost:3000/print', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(receiptData)
    });

    window.open('reciept.html', '_blank', 'width=500,height=700');

    cart = [];
    renderCart();
    alert('Sale recorded & sent to printer');
  } catch (err) {
    console.error(err);
    alert('Sale failed: ' + err.message);
  }
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
